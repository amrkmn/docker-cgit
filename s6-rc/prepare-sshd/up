#!/command/execlineb -P
# Create SSH directory structure
if { mkdir -p /opt/cgit/ssh }

# Generate SSH host keys in /etc/ssh if they don't exist
ifthenelse { test -f /etc/ssh/ssh_host_rsa_key }
{
    # Keys already exist
}
{
    /usr/bin/ssh-keygen -A
}

# Set correct permissions on SSH directory
if { chown -R git:git /opt/cgit/ssh }
if { chmod 700 /opt/cgit/ssh }

# Create authorized_keys if it doesn't exist
ifthenelse { test -f /opt/cgit/ssh/authorized_keys }
{
}
{
    /bin/touch /opt/cgit/ssh/authorized_keys
}

# Set permissions on authorized_keys
if { chmod 600 /opt/cgit/ssh/authorized_keys }

# Ensure repository directory exists with correct ownership
if { mkdir -p /opt/cgit/repositories }
if { chown -R git:git /opt/cgit/repositories }
if { chmod 755 /opt/cgit/repositories }
