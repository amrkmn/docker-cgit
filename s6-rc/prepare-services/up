#!/command/execlineb -P
# Consolidated service preparation script
# Adjust user IDs, create directories, and generate SSH keys

with-contenv
/bin/sh -c "
# Adjust user and group IDs based on environment variables
if [ -n \"\${PUID}\" ]; then
    if [ -n \"\${PGID}\" ]; then
        /usr/sbin/groupmod -g \"\${PGID}\" git
        /usr/sbin/usermod -u \"\${PUID}\" git
    else
        /usr/sbin/usermod -u \"\${PUID}\" git
    fi
fi

# Create fcgiwrap socket directory
mkdir -p /run/fcgiwrap
chown nginx:nginx /run/fcgiwrap

# Create SSH directory structure
mkdir -p /opt/cgit/data/ssh

# Generate SSH host keys if they don't exist
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
    /usr/bin/ssh-keygen -A
fi

# Set SSH permissions
chown -R git:git /opt/cgit/data/ssh
chmod 700 /opt/cgit/data/ssh

# Create authorized_keys if it doesn't exist
if [ ! -f /opt/cgit/data/ssh/authorized_keys ]; then
    /bin/touch /opt/cgit/data/ssh/authorized_keys
fi
chmod 600 /opt/cgit/data/ssh/authorized_keys

# Ensure repository directory exists with correct ownership
mkdir -p /opt/cgit/data/repositories
chown -R git:git /opt/cgit/data/repositories
chmod 755 /opt/cgit/data/repositories

# Configure git to trust all repositories in the data directory
# This fixes 'dubious ownership' errors when running git commands
su - git -c 'git config --global --add safe.directory \"*\"'

# Create logs directory for mirror-sync daemon
mkdir -p /opt/cgit/data/logs
chown -R git:git /opt/cgit/data/logs
chmod 755 /opt/cgit/data/logs
"