#!/bin/bash
# Repository management helper script for cgit
# Main entry point that loads modular command libraries
# Usage: repo <command> [args...]

set -e

# Default paths and settings
REPO_DIR="${REPO_DIR:-/opt/cgit/data/repositories}"
CACHE_DIR="${CACHE_DIR:-/opt/cgit/data/cache}"
CGIT_HOST="${CGIT_HOST:-localhost}"
CGIT_PORT="${CGIT_PORT:-2222}"
CGIT_OWNER="${CGIT_OWNER:-$(git config user.name 2>/dev/null || echo 'Unknown User')} <$(git config user.email 2>/dev/null || echo 'unknown@example.com')>"

# Determine script directory for library sourcing
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source library modules
source "$SCRIPT_DIR/lib/repo-utils.sh"
source "$SCRIPT_DIR/lib/repo-core.sh"
source "$SCRIPT_DIR/lib/repo-mirror.sh"

function show_help() {
    echo "cgit Repository Management"
    echo ""
    echo "Usage: repo <command> [args...]"
    echo ""
    echo "Commands:"
    echo "  create <name> [description] [owner]       Create a new bare repository"
    echo "  clone <url> [name] [description] [owner] [--mirror] [--schedule CRON] [--timeout SECONDS]"
    echo "                                             Clone/mirror a repository"
    echo "  update <name>                              Update a mirrored repository"
    echo "  delete <name> [--yes]                      Delete a repository"
    echo "  list                                       List all repositories"
    echo "  clear-cache                                Clear cgit cache"
    echo ""
    echo "Mirror auto-sync commands:"
    echo "  mirror enable <name> [--schedule CRON] [--timeout SECONDS]"
    echo "                                             Enable auto-sync for repository"
    echo "  mirror disable <name>                      Disable auto-sync"
    echo "  mirror list [--enabled-only]               List mirrored repositories"
    echo "  mirror status <name>                       Show mirror sync status"
    echo "  mirror sync <name>                         Manually sync repository now"
    echo "  mirror sync-all                            Sync all enabled mirrors"
    echo "  mirror logs [name]                         View sync logs"
    echo ""
    echo "Examples:"
    echo "  repo create my-project"
    echo "  repo clone https://github.com/user/repo.git"
    echo "  repo clone https://github.com/user/repo.git --mirror"
    echo "  repo clone https://github.com/user/repo.git --mirror --schedule '0 2 * * *'"
    echo "  repo mirror enable my-project"
    echo "  repo mirror sync my-project"
    echo "  repo update my-project"
    echo "  repo delete my-project"
    echo "  repo delete my-project --yes"
    echo "  repo list"
    echo ""
}

function main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 1
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            create_repo "$@"
            ;;
        clone)
            clone_repo "$@"
            ;;
        update)
            update_repo "$@"
            ;;
        delete)
            delete_repo "$@"
            ;;
        list)
            list_repos
            ;;
        clear-cache)
            clear_cache
            ;;
        mirror)
            mirror_command "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Error: Unknown command '$command'"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
