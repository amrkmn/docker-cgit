server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name _;
    
    root /opt/cgit/app;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Static files (CSS, images, favicon)
    location ~* ^.+\.(css|png|ico)$ {
        root /opt/cgit/app;
        expires 30d;
        access_log off;
    }
    
    # Default: try files, fall back to cgit
    location / {
        try_files $uri @cgit;
    }
    
    # cgit FastCGI handler
    location @cgit {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /opt/cgit/app/cgit.cgi;
        fastcgi_param PATH_INFO $uri;
        fastcgi_param QUERY_STRING $args;
        fastcgi_param HTTP_HOST $server_name;
        fastcgi_pass unix:/run/fcgiwrap/fcgiwrap.sock;
        
        # Route git operations to appropriate handlers
        # git-receive-pack (push) - BLOCK for HTTP
        if ($arg_service = git-receive-pack) {
            return 403 "HTTP push disabled. Use SSH: git@hostname:2222/opt/cgit/repositories/repo.git\n";
        }
        if ($uri ~ ^/.*/git-receive-pack$) {
            return 403 "HTTP push disabled. Use SSH: git@hostname:2222/opt/cgit/repositories/repo.git\n";
        }
        
        # git-upload-pack (fetch/pull) - ALLOW read-only
        if ($arg_service = git-upload-pack) {
            rewrite ^(.*)$ @git_read$1 last;
        }
        if ($uri ~ ^/.*/git-upload-pack$) {
            rewrite ^(.*)$ @git_read$1 last;
        }
        
        # info/refs - route based on service parameter
        if ($uri ~ ^/.*/info/refs$) {
            rewrite ^(.*)$ @git_read$1 last;
        }
    }
    
    # Git HTTP backend - read-only operations (clone, fetch, pull)
    location ~ @git_read/(.*) {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /usr/libexec/git-core/git-http-backend;
        fastcgi_param GIT_PROJECT_ROOT /opt/cgit/repositories;
        fastcgi_param GIT_HTTP_EXPORT_ALL "";
        fastcgi_param PATH_INFO /$1;
        fastcgi_param REMOTE_USER $remote_user;
        fastcgi_pass unix:/run/fcgiwrap/fcgiwrap.sock;
    }
}
